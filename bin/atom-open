#!/usr/bin/env bash
# Open files in Atom via the HTTP RPC.
# If it's not available, it falls back to atom's CLI.

API_HOST="http://127.0.0.1:58220"

# Opens files using the openFile RPC.
do_open_file () {
  # Build paths
  paths=""
  pwd="$(pwd -LP)"
  for fn in "$@"; do
    segment="\"${pwd}/${fn}\""
    if [ -n "$paths" ]; then
      paths="${paths},${segment}"
    else
      paths="${segment}"
    fi
  done

  # Build JSON data
  data="{\"paths\":[${paths}]}"

  # Send
  curl \
    --silent \
    --header "Content-Type: application/json" \
    --request POST \
    --data "$data" \
    "$API_HOST/do/openFile" >/dev/null
}

# Opens a workspace using the openWorkspace RPC.
do_open_workspace () {
  echo "(to be implemented)"
}

# Run
if [ -z "$1" ]; then
  # If no args were passed, just open Atom as usual
  atom
  exit $?
elif [ -d "$1" ]; then
  # If $1 is a directory, assume we're trying to open a workspace
  do_open_workspace "$@" || atom "$@"
  exit $?
else
  # Try to open the files in Atom
  do_open_file "$@" || atom "$@"
  exit $?
fi
